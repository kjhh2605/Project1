openapi: 3.0.3
info:
  title: Project1 Debugging Platform API
  version: 0.1.0
  description: |
    Project1 MVP API 명세.
    디버깅 중심 코딩 플랫폼의 문제 조회, 제출 생성, 제출 조회, 제출 이벤트 스트리밍(SSE) 제공.
servers:
  - url: http://localhost:8080
    description: local

tags:
  - name: Health
  - name: Problems
  - name: Submissions

paths:
  /healthz:
    get:
      tags: [Health]
      summary: 헬스체크
      operationId: getHealth
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /v1/problems:
    get:
      tags: [Problems]
      summary: 문제 목록 조회
      operationId: listProblems
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: size
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: difficulty
          schema:
            type: string
            enum: [easy, medium, hard]
      responses:
        '200':
          description: 문제 목록
          content:
            application/json:
              schema:
                type: object
                required: [items, page, size, total]
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProblemSummary'
                  page:
                    type: integer
                  size:
                    type: integer
                  total:
                    type: integer

  /v1/problems/{problemId}:
    get:
      tags: [Problems]
      summary: 문제 상세 조회
      operationId: getProblem
      parameters:
        - $ref: '#/components/parameters/ProblemId'
      responses:
        '200':
          description: 문제 상세
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '404':
          $ref: '#/components/responses/NotFound'

  /v1/submissions:
    post:
      tags: [Submissions]
      summary: 제출 생성
      operationId: createSubmission
      parameters:
        - in: header
          name: Idempotency-Key
          required: false
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSubmissionRequest'
      responses:
        '202':
          description: 제출 접수 완료
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateSubmissionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /v1/submissions/{submissionId}:
    get:
      tags: [Submissions]
      summary: 제출 상태/결과 조회
      operationId: getSubmission
      parameters:
        - $ref: '#/components/parameters/SubmissionId'
      responses:
        '200':
          description: 제출 상세
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionDetail'
        '404':
          $ref: '#/components/responses/NotFound'

  /v1/submissions/{submissionId}/events:
    get:
      tags: [Submissions]
      summary: 제출 이벤트 스트리밍(SSE)
      operationId: streamSubmissionEvents
      description: |
        제출 처리 상태를 Server-Sent Events로 스트리밍한다.
        `Last-Event-ID` 헤더를 사용하면 재연결 시 이어받을 수 있다.
      parameters:
        - $ref: '#/components/parameters/SubmissionId'
      responses:
        '200':
          description: text/event-stream 응답
          content:
            text/event-stream:
              schema:
                type: string
                example: |
                  id: 12
                  event: status
                  data: {"status":"running","progress":35}

components:
  parameters:
    ProblemId:
      in: path
      name: problemId
      required: true
      schema:
        type: string
        example: prob_001
    SubmissionId:
      in: path
      name: submissionId
      required: true
      schema:
        type: string
        example: sub_001

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    HealthResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          example: ok

    ProblemSummary:
      type: object
      required: [id, title, difficulty, languageTargets]
      properties:
        id:
          type: string
        title:
          type: string
        difficulty:
          type: string
          enum: [easy, medium, hard]
        languageTargets:
          type: array
          items:
            type: string
            enum: [java, python]

    ProblemDetail:
      allOf:
        - $ref: '#/components/schemas/ProblemSummary'
        - type: object
          required: [description, starterCode]
          properties:
            description:
              type: string
            starterCode:
              type: object
              additionalProperties:
                type: string
              example:
                java: "class Main { public static void main(String[] args) {} }"
                python: "def solve():\n    pass"
            rubricVersion:
              type: string
              example: r1.0

    CreateSubmissionRequest:
      type: object
      required: [problemId, language, patchedCode]
      properties:
        problemId:
          type: string
        language:
          type: string
          enum: [java, python]
        patchedCode:
          type: string
        explanation:
          type: string
          description: 사용자가 작성한 수정 근거/개선 설명

    CreateSubmissionResponse:
      type: object
      required: [submissionId, status]
      properties:
        submissionId:
          type: string
          example: sub_001
        status:
          type: string
          enum: [queued]

    SubmissionDetail:
      type: object
      required:
        - id
        - problemId
        - language
        - status
        - createdAt
      properties:
        id:
          type: string
        problemId:
          type: string
        language:
          type: string
          enum: [java, python]
        status:
          type: string
          enum:
            - queued
            - running
            - analyzing
            - ai_evaluating
            - completed
            - failed
        execution:
          type: object
          nullable: true
          properties:
            compileSuccess:
              type: boolean
            runtimeSuccess:
              type: boolean
            timeMs:
              type: integer
            memoryKb:
              type: integer
            stdout:
              type: string
            stderr:
              type: string
        staticAnalysis:
          type: array
          items:
            type: object
            properties:
              tool:
                type: string
              severity:
                type: string
                enum: [info, warning, error]
              ruleId:
                type: string
              message:
                type: string
              line:
                type: integer
        aiEvaluation:
          type: object
          nullable: true
          properties:
            modelTier:
              type: integer
              enum: [1, 2, 3]
            rubricVersion:
              type: string
            overallScore:
              type: integer
            feedback:
              type: string
            resultJson:
              type: object
              additionalProperties: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          example: SUBMISSION_NOT_FOUND
        message:
          type: string
          example: submission not found
        details:
          type: object
          additionalProperties: true
        traceId:
          type: string
